name: Check Updates
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq xmlstarlet
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 \
            -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      # ---------------------------
      # Extract CURRENT versions using yq
      # ---------------------------
      - name: Extract current versions from manifest
        id: local
        run: |
          CUR_ZYPAK=$(yq '.modules[] | select(.name=="zypak") | .sources[] | select(.type=="git") | .tag' com.ledger.ledgerwallet.yml)
          CUR_PNPM=$(yq '.modules[] | select(.name=="ledger-wallet") | .sources[] | select(.type=="file") | .url' com.ledger.ledgerwallet.yml | awk -F '/' '{print $8}')
          CUR_LL=$(yq '.modules[] | select(.name=="ledger-wallet") | .sources[] | select(.type=="git") | .tag' com.ledger.ledgerwallet.yml)

          echo "zypak=$CUR_ZYPAK" >> $GITHUB_OUTPUT
          echo "pnpm=$CUR_PNPM" >> $GITHUB_OUTPUT
          echo "ledger=$CUR_LL" >> $GITHUB_OUTPUT

      # ---------------------------
      # Get LATEST versions online
      # ---------------------------
      - name: Get latest versions
        id: remote
        run: |
          ZYPAK=$(curl -s https://api.github.com/repos/refi64/zypak/tags | jq -r '.[0].name')
          PNPM=$(curl -s https://api.github.com/repos/pnpm/pnpm/releases/latest | jq -r '.tag_name')
          LEDGER=$(curl -s https://api.github.com/repos/LedgerHQ/ledger-live/releases | \
            jq -r '.[].tag_name' | grep "@ledgerhq/live-desktop@" | head -n 1)

          echo "zypak=$ZYPAK" >> $GITHUB_OUTPUT
          echo "pnpm=$PNPM" >> $GITHUB_OUTPUT
          echo "ledger=$LEDGER" >> $GITHUB_OUTPUT

      # ---------------------------
      # UPDATE MANIFEST
      # ---------------------------
      - name: Apply updates
        id: update
        run: |
          CHANGED=false

          # Zypak
          if [ "${{ steps.local.outputs.zypak }}" != "${{ steps.remote.outputs.zypak }}" ]; then
            yq -i \
              "(.modules[] | select(.name==\"zypak\") | .sources[] | select(.type==\"git\") | .tag) = \"${{ steps.remote.outputs.zypak }}\"" \
              com.ledger.ledgerwallet.yml
            CHANGED=true
            echo "Updated Zypak"
          fi

          # Ledger Live
          if [ "${{ steps.local.outputs.ledger }}" != "${{ steps.remote.outputs.ledger }}" ]; then
            yq -i \
              "(.modules[] | select(.name==\"ledger-wallet\") | .sources[] | select(.type==\"git\") | .tag) = \"${{ steps.remote.outputs.ledger }}\"" \
              com.ledger.ledgerwallet.yml

            xmlstarlet ed -L \
              -u '/component/releases/release[1]/@version' \
              -v "${{ steps.remote.outputs.ledger }}" \
              com.ledger.ledgerwallet.metainfo.xml

            xmlstarlet ed -L \
              -u '/component/releases/release[1]/@date' \
              -v "$(date -u +%Y-%m-%d)" \
              com.ledger.ledgerwallet.metainfo.xml

            CHANGED=true
            echo "Updated Ledger Live"
          fi

          # PNPM
          if [ "${{ steps.local.outputs.pnpm }}" != "${{ steps.remote.outputs.pnpm }}" ]; then
            NEW_URL="https://github.com/pnpm/pnpm/releases/download/${{ steps.remote.outputs.pnpm }}/pnpm-linux-x64"
            curl -L -o pnpmdl "$NEW_URL"
            SHA256=$(sha256sum pnpmdl | awk '{print $1}')
            rm pnpmdl

            yq -i \
              "(.modules[] | select(.name==\"ledger-wallet\") | .sources[] | select(.type==\"file\") | .url) = \"$NEW_URL\"" \
              com.ledger.ledgerwallet.yml

            yq -i \
              "(.modules[] | select(.name==\"ledger-wallet\") | .sources[] | select(.type==\"file\") | .sha256) = \"$SHA256\"" \
              com.ledger.ledgerwallet.yml

            CHANGED=true
            echo "Updated pnpm"
          fi

          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

          if [ "$CHANGED" = false ]; then
            echo "No updates needed"
            exit 0
          fi

          # Commit
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add com.ledger.ledgerwallet.yml com.ledger.ledgerwallet.metainfo.xml
          git commit -m "ci(update): Update dependencies"

      # ---------------------------
      # BUILD DYNAMIC PR BODY (only changed deps)
      # ---------------------------
      - name: Build PR body
        id: pr_body
        if: steps.update.outputs.changed == 'true'
        run: |
          BODY=""

          if [ "${{ steps.local.outputs.zypak }}" != "${{ steps.remote.outputs.zypak }}" ]; then
            BODY="${BODY}- Zypak: ${{ steps.local.outputs.zypak }} → ${{ steps.remote.outputs.zypak }}"$'\n'
          fi

          if [ "${{ steps.local.outputs.pnpm }}" != "${{ steps.remote.outputs.pnpm }}" ]; then
            BODY="${BODY}- pnpm: ${{ steps.local.outputs.pnpm }} → ${{ steps.remote.outputs.pnpm }}"$'\n'
          fi

          if [ "${{ steps.local.outputs.ledger }}" != "${{ steps.remote.outputs.ledger }}" ]; then
            BODY="${BODY}- Ledger Live: ${{ steps.local.outputs.ledger }} → ${{ steps.remote.outputs.ledger }}"$'\n'
          fi

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ---------------------------
      # CREATE PR
      # ---------------------------
      - name: Create pull request
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Update dependencies"
          branch: "auto/update-deps"
          commit-message: "ci(update): Update dependencies"
          body: |
            Automatic update.

            Changes:
            ${{ steps.pr_body.outputs.body }}
          labels: update
          token: ${{ secrets.TOKEN }}
