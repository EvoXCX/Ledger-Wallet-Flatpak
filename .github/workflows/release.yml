name: Release Flatpak

on:
  push:
    branches:
      - main
    paths:
      - com.ledger.ledgerwallet.yml

permissions:
  contents: write
  actions: read

concurrency:
  group: flatpak-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-25.08
      options: --privileged

    steps:
      # ------------------------------
      # Checkout
      # ------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fix Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # ------------------------------
      # Parallel build
      # ------------------------------
      - name: Detect CPU count
        id: cpu
        run: echo "cpus=$(nproc)" >> $GITHUB_OUTPUT

      - name: Enable flatpak-builder parallel jobs
        run: echo "FLATPAK_BUILDER_N_JOBS=${{ steps.cpu.outputs.cpus }}" >> $GITHUB_ENV

      # ------------------------------
      # Install yq
      # ------------------------------
      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 \
            -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # ------------------------------
      # Build Flatpak
      # ------------------------------
      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: com.ledger.ledgerwallet.yml
          bundle: Ledger-Wallet.flatpak
          cache-key: flatpak-release-${{ github.sha }}

      # ------------------------------
      # Extract and convert Ledger version
      # ------------------------------
      - name: Read and convert Ledger version
        id: ledgerv
        run: |
          RAW=$(yq '.modules[] | select(.name=="ledger-wallet") | .sources[] | select(.type=="git") | .tag' com.ledger.ledgerwallet.yml)

          if [ -z "$RAW" ]; then
            echo "Error: Unable to extract Ledger version" >&2
            exit 1
          fi

          # Extract X.Y.Z from @ledgerhq/live-desktop@X.Y.Z
          VERSION="${RAW##*@}"

          # Convert to GitHub tag vX.Y.Z
          GIT_TAG="v${VERSION}"

          echo "raw=$RAW"
          echo "version=$VERSION"
          echo "tag=$GIT_TAG" >> $GITHUB_OUTPUT

          echo "Final Git tag: $GIT_TAG"

      # ------------------------------
      # Generate checksum
      # ------------------------------
      - name: Generate checksum
        id: sha256sum
        run: |
          sha256sum Ledger-Wallet.flatpak | tee Ledger-Wallet.flatpak.sha256
          echo "sha256_sum=$(cut -d ' ' -f1 Ledger-Wallet.flatpak.sha256)" >> $GITHUB_OUTPUT

      # ------------------------------
      # Release
      # ------------------------------
      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ledgerv.outputs.tag }}
          name: "Ledger Wallet â€“ ${{ steps.ledgerv.outputs.tag }}"
          body: |
            ## Ledger Wallet release

            **Version:** ${{ steps.ledgerv.outputs.tag }}

            **Checksum (SHA256):**
            ```
            ${{ steps.sha256sum.outputs.sha256_sum }}
            ```

            *Built automatically from manifest update.*
          files: |
            Ledger-Wallet.flatpak
            Ledger-Wallet.flatpak.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
