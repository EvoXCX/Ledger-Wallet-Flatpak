---
name: Release Flatpak
on:
  push:
    branches:
      - main
    paths:
      - com.Ledger.LedgerWallet.yml

jobs:
  release:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-25.08
      options: --privileged
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: com.Ledger.LedgerWallet.yml
          bundle: Ledger-Wallet.flatpak
          cache-key: flatpak-builder-${{ github.sha }}

      # ---------------------------
      # Compute release tag
      # ---------------------------
      - name: Read Ledger version
        id: ledgerv
        run: |
          VER=$(grep @ledgerhq/live-desktop@ com.Ledger.LedgerWallet.yml | awk -F "'" '{ print $2 }' | awk -F @ '{ print $NF }')
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Generate unique tag
        id: gentag
        run: |
          BASE="${{ steps.ledgerv.outputs.version }}"
          TAG="$BASE"
          i=1
          while git rev-parse "$TAG" >/dev/null 2>&1; do
            TAG="$BASE-$i"
            i=$((i+1))
          done
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # ---------------------------
      # CREATE RELEASE
      # ---------------------------
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.gentag.outputs.tag }}
          name: "Ledger Wallet - ${{ steps.gentag.outputs.tag }}"
          files: Ledger-Wallet.flatpak